<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title></title>

<link rel="stylesheet" type="text/css" href="/chat/css/qq.css"/>

	<meta charset="utf-8" name="viewport" content="width=device-width">
	<link rel="stylesheet" th:href="@{/webjars/mdui/dist/css/mdui.css}">
	<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
	<script th:src="@{/webjars/mdui/dist/js/mdui.js}"></script>
</head>
<body>

<div class="qqBox">
	<div class="BoxHead">
		<div class="headImg">
			<img src="/chat/img/6.jpg"/>
		</div>
		<div class="internetName"><i class="mdui-icon" id="username" th:text="${username}"></i></div>
	</div>
	<div class="context">
		<div class="conLeft">
			<ul>
				<li class="bg">
					<div class="liLeft"><img src="/chat/img/20170926103645_23.jpg"/></div>
					<div class="liRight">
						<span  class="intername">我的phone</span>
						<span class="infor">[文件]</span>
					</div>
				</li>
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_04.jpg"/></div>
					<div class="liRight">
						<span class="intername">区块链交流群</span>
						<span class="infor">厉害了</span>
					</div>
				</li>
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_19.jpg"/></div>
					<div class="liRight">
						<span  class="intername">赵鹏</span>
						<span class="infor">[流泪]</span>
					</div>
				</li>
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_27.jpg"/></div>
					<div class="liRight">
						<span  class="intername">web交流群</span>
						<span class="infor">666</span>
					</div>
				</li>
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_27.jpg"/></div>
					<div class="liRight">
						<span  class="intername">前端交流群</span>
						<span class="infor">前端小黑：怎么才能</span>
					</div>
				</li>
				
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_19.jpg"/></div>
					<div class="liRight">
						<span  class="intername">赵小雅</span>
						<span class="infor">[流泪]</span>
					</div>
				</li>
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_27.jpg"/></div>
					<div class="liRight">
						<span  class="intername">Java交流群</span>
						<span class="infor">[流泪]</span>
					</div>
				</li>
				
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_29.jpg"/></div>
					<div class="liRight">
						<span  class="intername">王二狗</span>
						<span class="infor">[流泪]</span>
					</div>
				</li>
				<li>
					<div class="liLeft"><img src="/chat/img/20170926103645_54.jpg"/></div>
					<div class="liRight">
						<span  class="intername">李大傻</span>
						<span class="infor">[流泪]</span>
					</div>
				</li>
			</ul>
		</div>
		<div class="conRight">
			<div class="Righthead">
				<div class="headName"></div>
				<div class="headConfig">
					<ul>
						<li><img src="/chat/img/20170926103645_06.jpg"/></li>
						<li><img src="/chat/img/20170926103645_08.jpg"/></li>
						<li><img src="/chat/img/20170926103645_10.jpg"/></li>
						<li><img src="/chat/img/20170926103645_12.jpg"/></li>
					</ul>
				</div>
			</div>
			<div class="RightCont">
				<ul class="newsList">
				
				</ul>
			</div>
			<div class="RightFoot">
				<div class="emjon">
					<ul>
						<li><img src="/chat/img/em_02.jpg"/></li>
						<li><img src="/chat/img/em_05.jpg"/></li>
						<li><img src="/chat/img/em_07.jpg"/></li>
						<li><img src="/chat/img/em_12.jpg"/></li>
						<li><img src="/chat/img/em_14.jpg"/></li>
						<li><img src="/chat/img/em_16.jpg"/></li>
						<li><img src="/chat/img/em_20.jpg"/></li>
						<li><img src="/chat/img/em_23.jpg"/></li>
						<li><img src="/chat/img/em_25.jpg"/></li>
						<li><img src="/chat/img/em_30.jpg"/></li>
						<li><img src="/chat/img/em_31.jpg"/></li>
						<li><img src="/chat/img/em_33.jpg"/></li>
						<li><img src="/chat/img/em_37.jpg"/></li>
						<li><img src="/chat/img/em_38.jpg"/></li>
						<li><img src="/chat/img/em_40.jpg"/></li>
						<li><img src="/chat/img/em_45.jpg"/></li>
						<li><img src="/chat/img/em_47.jpg"/></li>
						<li><img src="/chat/img/em_48.jpg"/></li>
						<li><img src="/chat/img/em_52.jpg"/></li>
						<li><img src="/chat/img/em_54.jpg"/></li>
						<li><img src="/chat/img/em_55.jpg"/></li>
					</ul>
				</div>
				<div class="footTop">
					<ul>
						<li><img src="/chat/img/20170926103645_31.jpg"/></li>
						<li class="ExP"><img src="/chat/img/20170926103645_33.jpg"/></li>
						<li><img src="/chat/img/20170926103645_35.jpg"/></li>
						<li><img src="/chat/img/20170926103645_37.jpg"/></li>
						<li><img src="/chat/img/20170926103645_39.jpg"/></li>
						<li><img src="/chat/img/20170926103645_41.jpg" alt="" /></li>
						<li><img src="/chat/img/20170926103645_43.jpg"/></li>
						<li><img src="/chat/img/20170926103645_45.jpg"/></li>
					</ul>
				</div>
				<div class="inputBox">
					<textarea id="msg" style="width: 99%;height: 75px; border: none;outline: none;" name="" rows="" cols=""></textarea>
					<button class="sendBtn" onclick="sendMsgToServer()">发送(s)</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript" src="/chat/js/jquery.min.js"></script>
<!--<script type="text/javascript" src="/chat/js/chat.js"></script>-->

<script th:inline="javascript">
    /**
     * WebSocket客户端
     *
     * 使用说明：
     * 1、WebSocket客户端通过回调函数来接收服务端消息。例如：webSocket.onmessage
     * 2、WebSocket客户端通过send方法来发送消息给服务端。例如：webSocket.send();
     */
    function getWebSocket() {
        /**
         * WebSocket客户端 PS：URL开头表示WebSocket协议 中间是域名端口 结尾是服务端映射地址
         */
        var webSocket = new WebSocket(/*[[${webSocketUrl}]]*/ 'ws://localhost:8080/chat');
        /**
         * 当服务端打开连接
         */
        webSocket.onopen = function (event) {
            console.log('WebSocket打开连接');
        };


        /**
         * 当服务端发来消息：1.广播消息 2.更新在线人数
         */
        webSocket.onmessage = function (event) {
            console.log('WebSocket收到消息：%c' + event.data, 'color:green');
            //获取服务端消息
            var message = JSON.parse(event.data) || {};
            var $messageContainer = $('.RightCont');
            //喉咙发炎
            if (message.type === 'SPEAK') {
                var answer='';
                answer+='<li>'+
                    '<div class="answerHead"><img src="img/tou.jpg"/></div>'+
                    '<div class="answers"><img class="jiao" src="/chat/img/jiao.jpg">'+message.msg+'</div>'+
                    '</li>';
                $('.newsList').append(answer);
                $('.RightCont').scrollTop($('.RightCont')[0].scrollHeight );
            }
            $('.chat-num').text(message.onlineCount);
            //防止刷屏
            var $cards = $messageContainer.children('.mdui-card:visible').toArray();
            if ($cards.length > 5) {
                $cards.forEach(function (item, index) {
                    index < $cards.length - 5 && $(item).slideUp('fast');
                });
            }
        };

        
        /**
         * 关闭连接
         */
        webSocket.onclose = function (event) {
            console.log('WebSocket关闭连接');
        };
        /**
         * 通信失败
         */
        webSocket.onerror = function (event) {
            console.log('WebSocket发生异常');
        };
        return webSocket;
    }
    var webSocket = getWebSocket();


    /**
     * 通过WebSocket对象发送消息给服务端
     */
    function sendMsgToServer() {
        var $message = $('#msg');
        alert($message.val())
        if ($message.val()) {
            webSocket.send(JSON.stringify({username: $('#username').text(), msg: $message.val()}));
            $message.val(null);

            var str='';
            str+='<li>'+
                '<div class="nesHead"><img src="img/6.jpg"/></div>'+
                '<div class="news"><img class="jiao" src="img/20170926103645_03_02.jpg">'+$message.val()+'</div>'+
                '</li>';
            $('.newsList').append(str);
        }
    }

    /**
     * 清屏
     */
    function clearMsg() {
        $(".RightCont").empty();
    }
    /**
     * 使用ENTER发送消息
     */
    document.onkeydown = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        e.keyCode === 13 && sendMsgToServer();
    };
</script>

</body>
</html>